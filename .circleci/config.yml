version: 2.1

# Executors for different platforms
executors:
  node-linux:
    docker:
      - image: cimg/node:18.20
    resource_class: large
  
  macos:
    macos:
      xcode: 15.3.0
    resource_class: macos.m1.large.gen1
  
  windows:
    machine:
      image: windows-server-2022-gui:2024.01.1
    resource_class: windows.large

# Commands for reusable steps
commands:
  install-dependencies:
    description: "Install npm dependencies with caching"
    steps:
      - restore_cache:
          keys:
            - v2-deps-{{ checksum "package-lock.json" }}
            - v2-deps-
      - run:
          name: Install dependencies
          command: npm ci
          environment:
            npm_config_build_from_source: false
      - save_cache:
          key: v2-deps-{{ checksum "package-lock.json" }}
          paths:
            - node_modules
            - ~/.cache/electron
            - ~/.cache/electron-builder
            - ~/.npm

  setup-linux-build-deps:
    description: "Install Linux build dependencies"
    steps:
      - run:
          name: Install build dependencies
          command: |
            sudo apt-get update -y
            sudo apt-get install -y dpkg fakeroot rpm

# Jobs
jobs:
  # Test and lint job for PRs
  test:
    executor: node-linux
    steps:
      - checkout
      - install-dependencies
      - run:
          name: Lint code
          command: npx eslint --ext .ts,.tsx .
      - run:
          name: Run unit tests
          command: npm run test
          environment:
            CI: true
      - run:
          name: Run end-to-end tests
          command: npm run test:e2e
          environment:
            CI: true
      - run:
          name: Generate test coverage
          command: npm run test:coverage
      - store_test_results:
          path: coverage
      - store_artifacts:
          path: coverage

  # Build job for Windows (main branch only)
  build-windows:
    executor: windows
    steps:
      - checkout
      - run:
          name: Setup Node.js environment
          command: |
            node --version
            npm --version
            echo "PATH: $PATH"
      - install-dependencies
      - run:
          name: Verify electron-forge installation
          command: |
            npx electron-forge --version
            echo "Electron-forge CLI verified"
      - run:
          name: Build Windows application
          command: NODE_ENV=production npx electron-forge make --platform=win32
          no_output_timeout: 20m
          environment:
            CI: true
            NODE_ENV: production
            OPENAI_API_KEY: ${OPENAI_API_KEY}
            REACT_APP_SUPABASE_URL: ${REACT_APP_SUPABASE_URL}
            REACT_APP_SUPABASE_ANON_KEY: ${REACT_APP_SUPABASE_ANON_KEY}
            REACT_APP_POSTHOG_KEY: ${REACT_APP_POSTHOG_KEY}
            REACT_APP_POSTHOG_HOST: ${REACT_APP_POSTHOG_HOST}
            DEEPGRAM_API_KEY: ${DEEPGRAM_API_KEY}
            BASETEN_API_KEY: ${BASETEN_API_KEY}
      - store_artifacts:
          path: out/make
          destination: windows-builds
      - persist_to_workspace:
          root: .
          paths:
            - out/make

  # Build job for macOS (main branch only)  
  build-macos:
    executor: macos
    steps:
      - checkout
      - run:
          name: Setup Node.js environment
          command: |
            node --version
            npm --version
            echo "PATH: $PATH"
            echo "Available disk space:"
            df -h
      - install-dependencies
      - run:
          name: Verify electron-forge installation
          command: |
            npx electron-forge --version
            echo "Electron-forge CLI verified"
      - run:
          name: Build macOS application
          command: NODE_ENV=production npx electron-forge make --platform=darwin
          no_output_timeout: 20m
          environment:
            CI: true
            NODE_ENV: production
            OPENAI_API_KEY: ${OPENAI_API_KEY}
            REACT_APP_SUPABASE_URL: ${REACT_APP_SUPABASE_URL}
            REACT_APP_SUPABASE_ANON_KEY: ${REACT_APP_SUPABASE_ANON_KEY}
            REACT_APP_POSTHOG_KEY: ${REACT_APP_POSTHOG_KEY}
            REACT_APP_POSTHOG_HOST: ${REACT_APP_POSTHOG_HOST}
            DEEPGRAM_API_KEY: ${DEEPGRAM_API_KEY}
            BASETEN_API_KEY: ${BASETEN_API_KEY}
      - store_artifacts:
          path: out/make
          destination: macos-builds
      - persist_to_workspace:
          root: .
          paths:
            - out/make

  # Release job - create GitHub release with artifacts
  create-release:
    executor: node-linux
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Install GitHub CLI
          command: |
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update
            sudo apt install gh -y
      - run:
          name: Create GitHub Release
          command: |
            # Get version from package.json
            VERSION="v$(node -p "require('./package.json').version")"
            
            # Check if release already exists
            if gh release view "$VERSION" >/dev/null 2>&1; then
              echo "Release $VERSION already exists, skipping creation"
              exit 0
            fi
            
            # Create release with artifacts
            gh release create "$VERSION" \
              --title "Release $VERSION" \
              --generate-notes \
              --notes "## ðŸš€ Overlay $VERSION
            
            **Automatically built from main branch**
            
            ### ðŸ“¦ Downloads
            
            - **Windows**: Download the \`.exe\` installer from the assets below
            - **macOS**: Download the \`.dmg\` file from the assets below
            
            ### ðŸ”§ Installation Notes
            
            - **Windows**: You may see SmartScreen warnings - click \"More info\" â†’ \"Run anyway\" (unsigned builds)
            - **macOS**: You may need to allow the app in System Preferences â†’ Privacy & Security (unsigned builds)
            - **Bug reports**: Please report issues via GitHub Issues
            
            ### âœ¨ Features
            
            - AI-powered speech-to-text transcription
            - Cross-platform text insertion
            - Dictionary replacements and customization
            - Multiple window management
            - Hotkey support (Option+Space on macOS, Ctrl+Windows+Space on Windows)" \
              out/make/**/*
          environment:
            GITHUB_TOKEN: ${GITHUB_TOKEN}

# Workflows
workflows:
  # PR workflow - tests and lint only
  pr-workflow:
    when:
      and:
        - not:
            equal: [ main, << pipeline.git.branch >> ]
        - not: << pipeline.git.tag >>
    jobs:
      - test

  # Main branch workflow - build and release only (quality already validated in PR)
  main-workflow:
    when:
      and:
        - equal: [ main, << pipeline.git.branch >> ]
        - not: << pipeline.git.tag >>
    jobs:
      - build-windows
      - build-macos
      - create-release:
          requires:
            - build-windows
            - build-macos

  # Manual workflow trigger (tags)
  manual-release:
    when: << pipeline.git.tag >>
    jobs:
      - build-windows
      - build-macos
      - create-release:
          requires:
            - build-windows
            - build-macos